---
name: xhs:generate-images
description: 为帖子生成统一风格的配图 - 读取人设形象、交互式选择风格、生成统一人物和风格的图片
argument-hint: --post <帖子文件路径> [--persona <人设名称>] [--count <数量>]
allowed-tools:
  - Read
  - Write
  - Bash
  - AskUserQuestion
---

# 生成配图命令

本命令为小红书帖子生成配图，**确保所有图片使用统一的人物形象和风格**。

## 使用方式

```bash
# 默认生成3张图片
/xhs:generate-images --post "文案生成/小红书自媒体帖子/账号/帖子目录/content.md"

# 指定人设和数量
/xhs:generate-images --post "文案生成/..." --persona "幼师小安" --count 5
```

参数：
- `--post`：帖子文件路径（必需）
- `--persona`：人设名称（可选，默认从帖子目录推断）
- `--count`：生成图片数量（可选，默认3张，建议3-7张）

## 执行流程

### 第一步：读取帖子和人设

1. 读取帖子文件，分析主题和情感基调
2. 确定使用的人设
3. **从人设文件中读取人物形象设计**

**重要**：所有人设文件必须包含 "### 人物形象设计" 部分

```bash
# 读取人设文件
Read $CLAUDE_PLUGIN_ROOT/personas/[人设名称].md
```

### 第二步：提取统一人物形象

从人设文件中提取：

1. **基础形象**：年龄感、体型、身高
2. **面部特征**：脸型、眼睛、鼻子、嘴巴、皮肤
3. **发型**：长度、颜色、质感、日常造型
4. **服装风格**：日常穿衣、代表单品、配饰、鞋子
5. **气质特点**：整体气质、表情特点、动作习惯
6. **不完美特征**：让形象更真实的细节

**构建统一形象描述**：
```
[人设名称]的标准形象：[完整形象描述]
```

**这个描述将在所有图片的提示词中使用！**

### 第三步：分析推荐风格

**重要**：必须与用户交互确认风格！

#### 风格分析

根据主题特点分析：

- **主题类型**：干货分享/生活记录/种草推荐/情感叙事
- **情感调性**：轻松活泼/温柔治愈/专业理性/励志向上
- **目标受众**：年轻学生/职场人士/宝妈群体

#### 推荐风格列表

推荐3-4种最适合的风格：

| 风格 | 特点 | 匹配度 |
|------|------|--------|
| 温暖治愈风 | 柔和光线、温暖色调、生活化场景 | ⭐⭐⭐⭐⭐ |
| 日系胶片风 | 胶片质感、低饱和度、复古怀旧 | ⭐⭐⭐⭐ |
| 极简ins风 | 简洁构图、留白、高级感 | ⭐⭐⭐ |

### 第四步：使用 AskUserQuestion 询问用户

```
根据主题"26岁才明白_原来我需要重新养育自己一次"，我推荐以下图片风格：

1. 温暖治愈风（推荐⭐⭐⭐⭐⭐）
   - 特点：柔和的光线、温暖的色调、生活化的场景
   - 适合：情感叙事、成长主题、女性共鸣内容

2. 日系胶片风（推荐⭐⭐⭐⭐）
   - 特点：轻微的胶片颗粒、低饱和度、复古怀旧
   - 适合：回忆叙事、时光流逝、内心独白

3. 极简ins风（推荐⭐⭐⭐）
   - 特点：简洁构图、留白、高级感
   - 适合：干货分享、方法论、理性思考

请选择本次图片生成的风格：
```

用户选择后锁定风格：
```
✅ 已选择：温暖治愈风
本次生成将统一使用此风格，确保所有图片风格一致。
```

### 第五步：规划图片场景

根据帖子内容，规划每张图的场景：

| 图片 | 类型 | 场景描述 |
|------|------|---------|
| image_01.jpg | 封面图 | [场景描述] |
| image_02.jpg | 内容图1 | [场景描述] |
| image_03.jpg | 内容图2 | [场景描述] |

**重要规则**：
- 每张图只有场景不同
- 人物形象完全相同
- 风格完全相同

### 第六步：生成统一风格的提示词

#### 提示词结构

```
[人设统一形象] + [场景/动作] + [选中风格描述] + [光影/色调] + [技术细节]
```

#### 生成示例

**封面图提示词**：
```
幼师小安的标准形象：26-28岁的亚洲女性，中等身材有些肉肉的可爱感，鹅蛋脸带一点婴儿肥，笑起来弯弯的杏眼很有亲和力，自然黑棕色的齐肩中长发柔软地披散着，穿着宽松舒适的米色针织开衫内搭白色衬衫。她坐在温馨的卧室窗边，阳光透过白色窗帘洒在她身上，她正在给自己泡一杯茶，眼神温和地望向窗外，表情平静而治愈。温暖治愈风格，柔和光线、米色系、温馨家居、生活质感，高质量，4K分辨率
```

**内容图1提示词**：
```
幼师小安的标准形象：[同上...]。她正在整理自己的小书桌，桌上放着一本打开的日记本、一杯冒热气的咖啡、一盆小小的绿植。她轻轻抚摸着日记本的页面，眼神温柔专注。温暖治愈风格，柔和光线、米色系、温馨家居、生活质感，高质量，4K分辨率
```

**注意**：所有提示词的"统一形象"部分完全相同！

### 第七步：调用API生成

#### 调用脚本

```bash
python3 $CLAUDE_PLUGIN_ROOT/scripts/generate_image.py \
  --prompt "完整提示词" \
  --output "/path/to/downloads/image_01.jpg"
```

**重要**：
- 脚本路径使用 `$CLAUDE_PLUGIN_ROOT` 环境变量
- 每个提示词都包含完整的人物形象描述
- 所有提示词使用相同的风格关键词

#### 生成控制

- 控制生成速度：RPS限制2请求/秒
- 失败重试：最多重试3次
- 进度提示：显示当前生成进度

### 第八步：下载和保存

1. 获取生成的图片URL
2. 下载图片到本地 `downloads/` 目录
3. 按序命名：image_01.jpg, image_02.jpg, ...
4. 记录图片元数据

### 第九步：一致性检查

生成完成后进行一致性检查：

```markdown
## 一致性检查
- ✅ 人物形象统一：所有图片使用相同的人物形象描述
- ✅ 风格统一：所有图片使用相同的风格关键词
- ✅ 色调一致：所有图片色调保持一致
```

## 输出格式

### 风格推荐报告

```markdown
# 图片风格推荐

## 帖子分析
- 主题：[主题]
- 情感基调：[调性]
- 目标受众：[受众]
- 人设：[人设名称]

## 推荐风格

### 1. 温暖治愈风（推荐⭐⭐⭐⭐⭐）
**特点**：柔和的光线、温暖的色调、生活化的场景
**适合原因**：这个主题是情感叙事，温暖治愈的风格能够传达内心的平静和治愈感
**参考关键词**：柔和光线、米色系、温馨家居、生活质感
**色调**：暖黄、米色、奶油色
**视觉参考**：阳光透过白色窗帘，温馨的卧室，柔和的光线

### 2. 日系胶片风（推荐⭐⭐⭐⭐）
**特点**：轻微的胶片颗粒、低饱和度、复古怀旧
**适合原因**：适合表达时光流逝和内心独白的情感
**参考关键词**：胶片质感、淡雅色调、柔和光影、岁月痕迹

### 3. 极简ins风（推荐⭐⭐⭐）
**特点**：简洁构图、留白、高级感
**适合原因**：如果想要更理性、更有秩序感的表达
**参考关键词**：极简构图、大面积留白、高级灰、秩序感

## 人设形象
✅ 将使用 [人设名称] 的统一形象：
- [简要形象描述]

## 请选择风格
请告诉我你想使用哪种风格，或提出你的风格偏好。
```

### 生成报告

```markdown
# 配图生成报告

## 帖子信息
- 文件：[路径]
- 主题：[主题]
- 使用人设：[人设名称]
- 选择风格：[风格名称]
- 生成时间：[时间]

## 统一设定
**人物形象**：[人设名称]的统一形象（所有图片使用相同形象）
**图片风格**：[风格名称]（所有图片使用相同风格）

## 图片生成详情

### 封面图 (image_01.jpg)
**提示词**：
```
[包含完整统一形象描述的提示词]
```
**设计意图**：封面吸引点击，展示核心场景
**场景**：[场景描述]
**状态**：✅ 成功

### 内容图1 (image_02.jpg)
**提示词**：
```
[包含完整统一形象描述的提示词]
```
**设计意图**：[设计意图]
**场景**：[场景描述]
**状态**：✅ 成功

[继续...]

## 生成结果

| 图片 | 状态 | 说明 |
|------|------|------|
| image_01.jpg | ✅ | 封面图 |
| image_02.jpg | ✅ | 内容展示 |
| image_03.jpg | ✅ | 内容展示 |

**成功**：3张
**失败**：0张

## 一致性检查
- ✅ 人物形象统一（所有图片使用相同形象描述）
- ✅ 风格统一（所有图片使用相同风格关键词）
- ✅ 色调一致（色调保持统一）

## 文件位置
图片已保存到：`[帖子目录]/downloads/`

## 后续建议
- [ ] 检查图片质量
- [ ] 确认人物形象是否一致
- [ ] 确认风格是否统一
- [ ] 必要时重新生成不满意的图片
```

## 风格选项参考

### 主流风格定义

| 风格 | 核心特征 | 色调 | 光影 | 构图 | 关键词 |
|------|---------|------|------|------|--------|
| **温暖治愈风** | 温馨、柔和、生活化 | 暖黄、米色、奶油色 | 柔和漫射光、自然光 | 生活化视角、特写 | 柔和光线、温馨、质感、生活气息 |
| **日系胶片风** | 复古、怀旧、淡雅 | 低饱和度、偏蓝或偏黄 | 柔和、有些朦胧 | 留白、意境感 | 胶片质感、淡雅、复古、岁月痕迹 |
| **极简ins风** | 简洁、高级、留白 | 黑白灰、大地色 | 平光、无明显阴影 | 极简构图、大面积留白 | 极简、高级、秩序、留白 |
| **清新森系风** | 自然、清新、文艺 | 绿色、白色、浅棕 | 自然光、斑驳光影 | 自然场景、生活化 | 清新、自然、森系、文艺 |
| **现代商务风** | 专业、干练、有质感 | 深蓝、灰色、黑色 | 明亮、对比明显 | 规整、对称 | 专业、现代、商务、质感 |
| **可爱卡通风** | 可爱、活泼、色彩丰富 | 明亮色彩、马卡龙色 | 平光、柔和 | 可爱元素、圆润造型 | 可爱、卡通、活泼、马卡龙色 |

## 环境变量要求

需要配置以下环境变量：

```bash
# Qwen-Image API Key（必需）
export DASHSCOPE_API_KEY="sk-xxxxxxxx"

# API端点（可选，默认北京）
export DASHSCOPE_API_URL="https://dashscope.aliyuncs.com/api/v1"
```

## 注意事项

### 1. 人物形象统一（最重要）
- ✅ 所有图片必须使用人设中的统一形象
- ❌ 不允许每张图片使用不同的人物形象
- ✅ 提示词中必须包含完整的人物形象描述

### 2. 风格统一（最重要）
- ✅ 所有图片必须使用用户选择的统一风格
- ✅ 风格关键词在所有提示词中保持一致
- ✅ 确保色调、光影、构图风格一致

### 3. 场景变化
- ✅ 只有场景和动作根据内容变化
- ✅ 人物形象和风格保持不变

### 4. API限制
- RPS限制：2请求/秒
- 控制并发数量
- 失败自动重试

### 5. 成本控制
- 价格：0.2元/张
- 建议先生成1张测试效果

### 6. 质量检查
- 生成后检查图片质量
- 检查人物形象是否一致
- 检查风格是否统一
- 不满意可重新生成

### 7. URL有效期
- 图片链接24小时有效
- 及时下载保存

## 错误处理

### API认证失败

```
❌ API认证失败

请检查环境变量：
export DASHSCOPE_API_KEY="your-key"

获取API Key：https://help.aliyun.com/zh/model-studio/get-api-key
```

### 人设文件缺少形象设计

```
❌ 人设文件缺少人物形象设计

人设文件 [人设名称] 中未找到 "### 人物形象设计" 部分。

请更新人设文件，添加人物形象描述，包括：
- 基础形象（年龄感、体型、身高）
- 面部特征（脸型、眼睛、鼻子、嘴巴、皮肤）
- 发型（长度、颜色、质感、日常造型）
- 服装风格（日常穿衣、代表单品、配饰、鞋子）
- 气质特点（整体气质、表情特点、动作习惯）
- 不完美特征（让形象更真实的细节）

参考模板：$CLAUDE_PLUGIN_ROOT/personas/示例人设.md
```

### API调用超时

```
⚠️ API调用超时

正在重试... (1/3)
正在重试... (2/3)
```

### 内容违规

```
❌ 生成失败：内容违规

提示词可能包含敏感内容，建议：
1. 修改提示词
2. 移除敏感词汇
3. 尝试其他表达方式
```

### 下载失败

```
⚠️ 图片下载失败

图片URL已保存，请手动下载：
[URL]

注意：URL有效期24小时
```

## 成本估算

| 数量 | 成本 |
|------|------|
| 1张 | 0.2元 |
| 3张 | 0.6元 |
| 5张 | 1.0元 |
| 7张 | 1.4元 |

建议：
- 测试阶段：生成1张检查效果
- 正式发布：生成3-7张

## 下一步

图片生成完成后：
1. ✅ 检查人物形象是否一致
2. ✅ 检查风格是否统一
3. ✅ 检查图片质量
4. 使用 `/xhs:publish` 发布
5. 或继续编辑调整
